<!doctype html>
<html lang="uk">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>MAXMAL STUDIO — G-Wagen Interior Tool (MVP)</title>
  <style>
    :root{
      --bg:#0b0b0d;
      --panel:#121216;
      --accent:#ff6a00;   /* оранжевий */
      --accent-2:#ff9350;
      --text:#f2f2f2;
      --sub:#9aa0a6;
      --border:#22242a;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;background:var(--bg);color:var(--text);
      font-family: Inter, system-ui, -apple-system, Arial, sans-serif;
    }
    header{
      display:flex;align-items:center;justify-content:space-between;
      padding:14px 20px;border-bottom:1px solid var(--border);
      background:linear-gradient(180deg,#0d0d10 0%, #0a0a0c 100%);
      position:sticky;top:0;z-index:10;
    }
    .brand{display:flex;gap:10px;align-items:center}
    .logo{
      width:34px;height:34px;border-radius:8px;
      background:var(--accent);
      box-shadow:0 0 0 2px #000 inset, 0 8px 30px rgba(255,106,0,.25);
      display:grid;place-items:center;font-weight:800;color:#000;
    }
    .title{font-weight:800;letter-spacing:.4px}
    .sub{color:var(--sub);font-size:12px}

    .wrap{display:grid;grid-template-columns: 1fr 320px;gap:18px;padding:16px;max-width:1200px;margin:0 auto}
    @media (max-width: 940px){ .wrap{grid-template-columns:1fr} }

    .card{
      background:var(--panel);border:1px solid var(--border);
      border-radius:14px;box-shadow:0 10px 30px rgba(0,0,0,.35);
      padding:14px;
    }
    .toolbar{display:flex;flex-wrap:wrap;gap:10px;margin-bottom:12px}
    .btn{
      appearance:none;border:none;cursor:pointer;
      background:var(--accent);color:#000;font-weight:700;
      padding:10px 14px;border-radius:10px;transition:.15s;
    }
    .btn:disabled{opacity:.5;cursor:not-allowed}
    .btn.secondary{background:#1b1c21;color:var(--text);border:1px solid var(--border)}
    .btn.ghost{background:transparent;border:1px solid var(--border);color:var(--text)}
    input[type="file"]{display:none}
    .file-label{
      background:#1b1c21;border:1px solid var(--border);color:var(--text);
      padding:10px 14px;border-radius:10px;cursor:pointer;font-weight:600;
    }

    .stage{
      position:relative;display:block;width:100%;aspect-ratio: 16/10;
      background:#0f0f12;border-radius:12px;border:1px solid var(--border);
      overflow:hidden;
    }
    canvas, .overlay{
      position:absolute;inset:0;width:100%;height:100%;object-fit:contain;
      image-rendering: crisp-edges;
    }
    .tip{font-size:12px;color:var(--sub);margin-top:8px}

    .panel-title{font-size:13px;color:var(--sub);margin-bottom:8px}
    .stack{display:flex;flex-direction:column;gap:8px}
    .row{display:flex;gap:8px;align-items:center}
    .pill{
      padding:6px 10px;border-radius:999px;background:#17181d;border:1px solid var(--border);
      font-size:12px;color:var(--sub)
    }
    .ok{color:#7dffa1}
    .err{color:#ff8b8b}
  </style>
</head>
<body>

<header>
  <div class="brand">
    <div class="logo">M</div>
    <div>
      <div class="title">MAXMAL STUDIO</div>
      <div class="sub">G-Wagen Interior Tool (MVP)</div>
    </div>
  </div>
  <div class="sub">чорно-оранжевий стиль • демо AI</div>
</header>

<div class="wrap">
  <div class="card">
    <div class="toolbar">
      <label class="file-label"><input id="file" type="file" accept="image/*" />Завантажити фото</label>
      <button class="btn ghost" id="btnDetect" disabled>Перевірити авто</button>
      <button class="btn" id="btnAuto" disabled>Авто-розпізнавання</button>
      <button class="btn secondary" id="btnClear" disabled>Очистити маску</button>
      <span id="status" class="pill">Готово</span>
    </div>

    <div class="stage" id="stage">
      <!-- базове зображення -->
      <canvas id="photo"></canvas>
      <!-- маска (малюємо сюди) -->
      <canvas id="mask"></canvas>
      <!-- показ AI-маски у вигляді картинки (PNG з прозорістю) -->
      <img id="maskPng" class="overlay" style="opacity:.35;display:none;" alt="">
    </div>
    <div class="tip">
      1) Завантаж фото дверної карти. 2) Натисни <b>Перевірити авто</b> — побачиш марку/модель (демо). 3) Натисни <b>Авто-розпізнавання</b> — при наявності ключа AI отримаєш маски; без ключа — демо-повідомлення.
    </div>
  </div>

  <div class="card">
    <div class="panel-title">Авто (демо)</div>
    <div class="stack" style="gap:6px;">
      <div class="row"><div class="pill">Марка:</div><div id="make">—</div></div>
      <div class="row"><div class="pill">Модель:</div><div id="model">—</div></div>
      <div class="row"><div class="pill">Ймовірність:</div><div id="conf">—</div></div>
    </div>
    <hr style="border-color:#1f2025;margin:12px 0">
    <div class="panel-title">Статус</div>
    <div id="log" class="tip">Очікує фото…</div>
  </div>
</div>

<script>
  /* =====  Налаштування  ===== */
  // якщо сервер локально: 
  const API_BASE = 'http://localhost:3000';

  /* =====  DOM  ===== */
  const fileInput  = document.getElementById('file');
  const btnDetect  = document.getElementById('btnDetect');
  const btnAuto    = document.getElementById('btnAuto');
  const btnClear   = document.getElementById('btnClear');
  const statusEl   = document.getElementById('status');
  const logEl      = document.getElementById('log');

  const photoCan   = document.getElementById('photo');
  const maskCan    = document.getElementById('mask');
  const maskPngImg = document.getElementById('maskPng');
  const stage      = document.getElementById('stage');

  const pctx = photoCan.getContext('2d');
  const mctx = maskCan.getContext('2d');

  let hasImage = false;
  let imgW = 0, imgH = 0;

  /* =====  Допоміжні  ===== */
  function setBusy(on, text){
    statusEl.textContent = on ? (text||'Працюю…') : 'Готово';
    btnDetect.disabled = on || !hasImage;
    btnAuto.disabled   = on || !hasImage;
    btnClear.disabled  = on || !hasImage;
  }
  function fitToStage(w,h){
    // канваси завжди піксель-в-піксель з картинкою для коректної маски
    photoCan.width = maskCan.width = w;
    photoCan.height = maskCan.height = h;
    stage.style.aspectRatio = `${w}/${h}`;
  }
  function clearMask(){
    mctx.clearRect(0,0,maskCan.width,maskCan.height);
    maskPngImg.style.display='none';
  }
  function blobFromPhotoCanvas(){
    return new Promise(res => photoCan.toBlob(b=>res(b),'image/jpeg',0.92));
  }

  /* =====  Завантаження фото  ===== */
  fileInput.addEventListener('change', async (e)=>{
    const file = e.target.files[0];
    if(!file) return;
    setBusy(true,'Завантажую фото…');
    clearMask();

    const img = new Image();
    img.onload = ()=>{
      imgW = img.naturalWidth; imgH = img.naturalHeight;
      fitToStage(imgW, imgH);
      pctx.clearRect(0,0,imgW,imgH);
      pctx.drawImage(img,0,0,imgW,imgH);
      hasImage = true;
      btnDetect.disabled = false;
      btnAuto.disabled = false;
      btnClear.disabled = false;
      logEl.textContent = 'Фото завантажено. Можна перевірити авто або запустити авто-розпізнавання.';
      setBusy(false);
    };
    img.onerror = ()=>{ setBusy(false); alert('Не вдалося прочитати зображення'); };
    img.src = URL.createObjectURL(file);
  });

  btnClear.addEventListener('click', ()=>{ clearMask(); });

  /* =====  Запит: /detect-car  ===== */
  async function callDetectCar(){
    const blob = await blobFromPhotoCanvas();
    const fd = new FormData();
    fd.append('image', blob, 'photo.jpg');
    const r = await fetch(API_BASE + '/detect-car', { method:'POST', body: fd });
    if(!r.ok) throw new Error('detect-car failed');
    return await r.json(); // { make, model, confidence }
  }

  btnDetect.addEventListener('click', async ()=>{
    if(!hasImage) return;
    setBusy(true,'Визначаю авто…');
    try{
      const det = await callDetectCar();
      document.getElementById('make').textContent  = det.make  || '—';
      document.getElementById('model').textContent = det.model || '—';
      document.getElementById('conf').textContent  = det.confidence ? (Math.round(det.confidence*100)+'%') : '—';
      logEl.innerHTML = `<span class="ok">OK</span> Авто: ${det.make} ${det.model}`;
    }catch(e){
      console.error(e);
      logEl.innerHTML = `<span class="err">Помилка</span> не вдалося визначити авто (перевір сервер)`;
      alert('Не вдалося визначити авто. Переконайся, що server.js запущено.');
    }finally{
      setBusy(false);
    }
  });

  /* =====  Запит: /auto-segment  ===== */
  async function callAutoSegment(){
    const blob = await blobFromPhotoCanvas();
    const fd = new FormData();
    fd.append('image', blob, 'photo.jpg');
    const r = await fetch(API_BASE + '/auto-segment', { method:'POST', body: fd });
    if(!r.ok) throw new Error('auto-segment failed');
    return await r.json(); // { masks: [{type:'png', url:'...'}] або [] у демо }
  }

  btnAuto.addEventListener('click', async ()=>{
    if(!hasImage) return;
    setBusy(true,'Шукаю елементи…');
    clearMask();
    try{
      const { masks=[] } = await callAutoSegment();
      if(!masks.length){
        logEl.innerHTML = `Зараз <b>демо-режим</b> (ключ AI не задано). Контури генеруйте локальними інструментами.`;
        alert('Демо-режим без AI: додай ключі в .env, щоб отримувати маски від моделі SAM.');
      }else{
        // показуємо першу маску як напівпрозорий PNG поверх канвасу
        maskPngImg.onload = ()=>{
          // розтягнемо 1:1 у пікселі (канвас і зображення однакового розміру)
          maskPngImg.style.display = 'block';
          logEl.innerHTML = `<span class="ok">OK</span> Отримано масок: ${masks.length}. Показав першу.`;
        };
        maskPngImg.crossOrigin = 'anonymous';
        maskPngImg.src = masks[0].url;
      }
    }catch(e){
      console.error(e);
      logEl.innerHTML = `<span class="err">Помилка</span> авто-розпізнавання не спрацювало.`;
      alert('Не вийшло отримати маски. Перевір server.js та ключі у .env');
    }finally{
      setBusy(false);
    }
  });
</script>
</body>
</html>
