<!doctype html>
<html lang="uk">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>MAXMAL STUDIO — Interior AI (G-Wagen MVP)</title>

  <style>
    :root{
      --bg:#0b0b0d;
      --panel:#121216;
      --panel2:#0f0f14;
      --accent:#ff6a00;
      --accent2:#ff9a47;
      --text:#f2f2f2;
      --sub:#9aa0a6;
      --border:#23242a;
      --danger:#ff5f5f;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;background:var(--bg);color:var(--text);
      font-family: Inter, system-ui, -apple-system, Arial, sans-serif;
    }
    header{
      display:flex;align-items:center;justify-content:space-between;
      padding:14px 20px;border-bottom:1px solid var(--border);
      background:linear-gradient(180deg,#0d0d10 0%, #0a0a0c 100%);
      position:sticky;top:0;z-index:10;
    }
    .brand{display:flex;gap:10px;align-items:center}
    .logo{
      width:34px;height:34px;border-radius:8px;background:var(--accent);
      color:#000;font-weight:800;display:grid;place-items:center;
      box-shadow:0 0 0 2px #000 inset, 0 10px 30px rgba(255,106,0,.25);
    }
    .title{font-weight:800;letter-spacing:.4px}
    .sub{color:var(--sub);font-size:12px}

    .wrap{display:grid;grid-template-columns: 1fr 340px;gap:18px;padding:16px;max-width:1280px;margin:0 auto}
    @media (max-width: 980px){ .wrap{grid-template-columns:1fr} }

    .card{
      background:var(--panel);border:1px solid var(--border);
      border-radius:14px;box-shadow:0 10px 30px rgba(0,0,0,.35);
      padding:14px;
    }

    .toolbar{display:flex;flex-wrap:wrap;gap:10px;margin-bottom:12px}
    input[type="file"]{display:none}
    .file-label, .btn{
      padding:10px 14px;border-radius:10px;font-weight:700;cursor:pointer;user-select:none;
      border:1px solid var(--border);background:#1b1c21;color:var(--text);
    }
    .btn.primary{background:var(--accent);color:#000;border-color:#000}
    .btn.ghost{background:transparent}
    .btn.warn{background:#201417;border-color:#3d1f26;color:#ffb3b3}
    .btn:disabled{opacity:.55;cursor:not-allowed}

    .seg-mode{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
    .seg-mode .pill{padding:6px 10px;border-radius:999px;border:1px solid var(--border);background:#17181d;font-size:12px;color:var(--sub)}
    .seg-mode input[type=range]{width:180px}

    .stage{
      position:relative;width:100%;aspect-ratio: 16/10;border-radius:12px;
      border:1px solid var(--border);background:var(--panel2);overflow:hidden;
    }
    canvas,.overlay{position:absolute;inset:0;width:100%;height:100%;object-fit:contain}
    .overlay{opacity:.35;pointer-events:none;display:none}

    .right .section-title{font-size:13px;color:var(--sub);margin:10px 0 6px}
    .palette{display:grid;grid-template-columns: repeat(10, 1fr);gap:6px}
    .sw{width:24px;height:24px;border-radius:6px;border:1px solid #000;cursor:pointer}
    .row{display:flex;align-items:center;gap:8px}
    .select, .input{
      width:100%;padding:10px 12px;border-radius:10px;border:1px solid var(--border);
      background:#1a1b20;color:var(--text)
    }
    .tip{font-size:12px;color:var(--sub);margin-top:10px}
    .ok{color:#79ffa2}.err{color:#ff8b8b}
    .status{margin-left:auto;padding:6px 10px;border-radius:999px;border:1px solid var(--border);background:#17181d;font-size:12px;color:var(--sub)}
  </style>
</head>
<body>

<header>
  <div class="brand">
    <div class="logo">M</div>
    <div>
      <div class="title">MAXMAL STUDIO — Interior AI</div>
      <div class="sub">G-Wagen Interior Tool (MVP) • чорний-оранжевий стиль</div>
    </div>
  </div>
  <div class="status" id="status">Готово</div>
</header>

<div class="wrap">
  <!-- LEFT: редактор -->
  <div class="card">
    <div class="toolbar">
      <label class="file-label"><input id="file" type="file" accept="image/*">Завантажити фото</label>
      <button class="btn" id="btnAuto">Авто-розпізнавання</button>
      <button class="btn ghost" id="btnMagic">Клік (Magic)</button>
      <button class="btn ghost" id="btnBrush">Пензлик</button>
      <button class="btn ghost" id="btnEraser">Гумка</button>
      <button class="btn ghost" id="btnRefine">Уточнити маску</button>
      <button class="btn warn" id="btnClear">Очистити маску</button>
      <label class="row" style="margin-left:auto;gap:6px;">
        <input type="checkbox" id="showMask" checked>
        <span class="sub">Показати маску</span>
      </label>
    </div>

    <div class="seg-mode" style="margin-bottom:10px;">
      <div class="pill">Розмір кисті</div>
      <input type="range" id="brushSize" min="4" max="120" value="32">
      <div class="pill">Толерантність (Magic)</div>
      <input type="range" id="tolerance" min="1" max="80" value="24">
    </div>

    <div class="stage" id="stage">
      <canvas id="photo"></canvas>   <!-- базове фото / результат -->
      <canvas id="mask"></canvas>    <!-- бінарна маска 0/255 -->
      <img id="maskPng" class="overlay" alt=""> <!-- AI PNG маска -->
    </div>

    <div class="tip">
      1) Завантаж фото дверної карти. 2) Натисни <b>Авто-розпізнавання</b> щоб AI запропонував елементи (без ключа — демо). 3) Клік (Magic) або пензлик/гумка для правок. 4) Колір/матеріал застосовуються <b>тільки всередині маски</b>.
    </div>
  </div>

  <!-- RIGHT: інструменти -->
  <div class="card right">
    <div class="section-title">Авто (демо)</div>
    <div class="row" style="justify-content:space-between"><span class="sub">Марка:</span> <b id="make">—</b></div>
    <div class="row" style="justify-content:space-between"><span class="sub">Модель:</span> <b id="model">—</b></div>
    <div class="row" style="justify-content:space-between"><span class="sub">Ймовірність:</span> <b id="conf">—</b></div>
    <button class="btn primary" id="btnDetect" style="margin-top:8px;width:100%;">Перевірити авто</button>

    <hr style="border-color:#1f2025;margin:14px 0">

    <div class="section-title">Колір</div>
    <div class="palette" id="palette"></div>
    <div class="row" style="margin-top:8px">
      <input type="color" id="anyColor" class="input" value="#ff6a00" style="height:40px;">
    </div>

    <div class="section-title">Матеріал</div>
    <select id="material" class="select">
      <option value="leather">Шкіра</option>
      <option value="alcantara">Алькантара</option>
    </select>

    <div class="section-title">Перфорація</div>
    <label class="row"><input type="checkbox" id="perforated"> <span>Увімкнути перфорацію</span></label>

    <div class="section-title">Строчки</div>
    <button class="btn ghost" id="btnStitches" style="width:100%;">Відкрити вікно строчок</button>

    <hr style="border-color:#1f2025;margin:14px 0">
    <button class="btn primary" id="btnApply" style="width:100%;">Застосувати до маски</button>

    <div class="section-title">Статус</div>
    <div id="log" class="tip">Очікує фото…</div>
  </div>
</div>

<script>
/* ================== БАЗА ================== */
const API_BASE = 'http://localhost:3000';

const statusEl = document.getElementById('status');
function setBusy(on, text){
  statusEl.textContent = on ? (text || 'Працюю…') : 'Готово';
}

/* ===== Canvas & стани ===== */
const stage    = document.getElementById('stage');
const photoCan = document.getElementById('photo');
const maskCan  = document.getElementById('mask');
const maskPng  = document.getElementById('maskPng');
const pctx = photoCan.getContext('2d');
const mctx = maskCan.getContext('2d');

let baseImgData = null; // оригінал зображення
let hasImage = false;
let imgW = 0, imgH = 0;

function fitCanvases(w,h){
  photoCan.width = maskCan.width = w;
  photoCan.height = maskCan.height = h;
  stage.style.aspectRatio = `${w}/${h}`;
}

function clearMask(){
  mctx.clearRect(0,0,maskCan.width,maskCan.height);
  maskPng.style.display = 'none';
}

function getPhotoBlob(){
  return new Promise(res => photoCan.toBlob(b=>res(b), 'image/jpeg', 0.92));
}

/* ================== ЗАВАНТАЖЕННЯ ФОТО ================== */
const fileInput  = document.getElementById('file');
const logEl      = document.getElementById('log');
const showMaskEl = document.getElementById('showMask');

fileInput.addEventListener('change', e=>{
  const f = e.target.files[0];
  if(!f) return;
  setBusy(true,'Завантажую фото…');
  const img = new Image();
  img.onload = ()=>{
    imgW = img.naturalWidth; imgH = img.naturalHeight;
    fitCanvases(imgW,imgH);
    pctx.clearRect(0,0,imgW,imgH);
    pctx.drawImage(img,0,0,imgW,imgH);
    baseImgData = pctx.getImageData(0,0,imgW,imgH); // збережемо оригінал
    hasImage = true;
    clearMask();
    setBusy(false);
    logEl.textContent = 'Фото завантажено. Можна авто-розпізнання або ручні інструменти.';
  };
  img.onerror = ()=>{ setBusy(false); alert('Не вдалось прочитати зображення'); };
  img.src = URL.createObjectURL(f);
});

showMaskEl.addEventListener('change', ()=>{
  maskCan.style.display = showMaskEl.checked ? 'block' : 'none';
  maskPng.style.display = (showMaskEl.checked && maskPng.src) ? 'block' : 'none';
});

/* ================== АВТО (DEMO/AI) ================== */
const makeEl  = document.getElementById('make');
const modelEl = document.getElementById('model');
const confEl  = document.getElementById('conf');
const btnDetect = document.getElementById('btnDetect');
const btnAuto   = document.getElementById('btnAuto');

btnDetect.addEventListener('click', async ()=>{
  if(!hasImage) return alert('Завантаж спочатку фото');
  setBusy(true,'Визначаю авто…');
  try{
    const blob = await getPhotoBlob();
    const fd = new FormData(); fd.append('image', blob, 'photo.jpg');
    const r = await fetch(API_BASE + '/detect-car', { method:'POST', body: fd });
    const data = await r.json();
    makeEl.textContent  = data.make || '—';
    modelEl.textContent = data.model || '—';
    confEl.textContent  = data.confidence ? Math.round(data.confidence*100)+'%' : '—';
    logEl.innerHTML = `<span class="ok">OK</span> Авто: ${makeEl.textContent} ${modelEl.textContent}`;
  }catch(e){
    console.error(e);
    logEl.innerHTML = `<span class="err">Помилка</span> не вдалося визначити авто (сервер)`;
  }finally{ setBusy(false); }
});

btnAuto.addEventListener('click', async ()=>{
  if(!hasImage) return alert('Завантаж спочатку фото');
  setBusy(true,'Шукаю елементи…');
  clearMask();
  try{
    const blob = await getPhotoBlob();
    const fd = new FormData(); fd.append('image', blob, 'photo.jpg');
    const r = await fetch(API_BASE + '/auto-segment', { method:'POST', body: fd });
    const { masks=[] } = await r.json();
    if(!masks.length){
      alert('Демо-режим без AI-ключа: локально користуйся Magic/Пензлем. Додай ключ — отримаєш AI-маски.');
      logEl.textContent = 'Демо-режим: AI маски не повернено.';
    }else{
      maskPng.onload = ()=>{ if(showMaskEl.checked) maskPng.style.display='block'; };
      maskPng.crossOrigin = 'anonymous';
      maskPng.src = masks[0].url;
      logEl.innerHTML = `<span class="ok">OK</span> Отримано AI-маски: ${masks.length} (показана перша).`;
    }
  }catch(e){
    console.error(e);
    logEl.innerHTML = `<span class="err">Помилка</span> авто-маски не отримано.`;
  }finally{ setBusy(false); }
});

/* ================== РУЧНІ ІНСТРУМЕНТИ (МАСКА) ================== */
const btnMagic  = document.getElementById('btnMagic');
const btnBrush  = document.getElementById('btnBrush');
const btnEraser = document.getElementById('btnEraser');
const btnRefine = document.getElementById('btnRefine');
const btnClear  = document.getElementById('btnClear');
const tolEl     = document.getElementById('tolerance');
const sizeEl    = document.getElementById('brushSize');

let tool = 'magic'; // magic | brush | eraser

btnMagic.onclick = ()=> tool='magic';
btnBrush.onclick = ()=> tool='brush';
btnEraser.onclick= ()=> tool='eraser';

btnClear.onclick = ()=> clearMask();

btnRefine.onclick = ()=>{
  // просте "пригладжування" маски: легке розмиття + поріг
  const id = mctx.getImageData(0,0,maskCan.width,maskCan.height);
  const p = id.data, w=id.width, h=id.height;
  // дуже простий box-blur 3x3 на альфа-каналі
  const a = new Uint8ClampedArray(w*h);
  for(let y=0;y<h;y++){
    for(let x=0;x<w;x++){
      let s=0,c=0;
      for(let dy=-1;dy<=1;dy++){
        for(let dx=-1;dx<=1;dx++){
          const xx=x+dx, yy=y+dy;
          if(xx>=0&&xx<w&&yy>=0&&yy<h){ s += p[(yy*w+xx)*4+3]; c++; }
        }
      }
      a[y*w+x]=s/c|0;
    }
  }
  for(let i=0;i<w*h;i++){
    const v = a[i]>127?255:0;
    p[i*4+0]=255; p[i*4+1]=255; p[i*4+2]=255; p[i*4+3]=v;
  }
  mctx.putImageData(id,0,0);
};

function applyPointMagic(x,y, tol){
  // простий flood fill по кольору базового зображення -> малюємо у маску
  const id = pctx.getImageData(0,0,imgW,imgH);
  const md = mctx.getImageData(0,0,imgW,imgH);
  const p = id.data, m = md.data;
  const idx = (y*imgW+x)*4;
  const r0=p[idx], g0=p[idx+1], b0=p[idx+2];
  const stack=[[x,y]];
  const seen=new Uint8Array(imgW*imgH);
  const T = tol*3.2; // грубо
  while(stack.length){
    const [cx,cy]=stack.pop();
    if(cx<0||cy<0||cx>=imgW||cy>=imgH) continue;
    const i = cy*imgW+cx;
    if(seen[i]) continue; seen[i]=1;
    const j=i*4;
    const dr=p[j]-r0, dg=p[j+1]-g0, db=p[j+2]-b0;
    if((Math.abs(dr)+Math.abs(dg)+Math.abs(db))<=T){
      m[j]=255;m[j+1]=255;m[j+2]=255;m[j+3]=255;
      stack.push([cx+1,cy]);stack.push([cx-1,cy]);
      stack.push([cx,cy+1]);stack.push([cx,cy-1]);
    }
  }
  mctx.putImageData(md,0,0);
}

let drawing=false;
maskCan.addEventListener('mousedown', e=>{
  if(!hasImage) return;
  const rect = maskCan.getBoundingClientRect();
  const x = Math.round((e.clientX-rect.left)/rect.width*imgW);
  const y = Math.round((e.clientY-rect.top )/rect.height*imgH);
  if(tool==='magic'){
    applyPointMagic(x,y, +tolEl.value);
  }else{
    drawing=true;
    drawAt(e);
  }
});
maskCan.addEventListener('mousemove', e=>{ if(drawing) drawAt(e); });
window.addEventListener('mouseup', ()=> drawing=false);

function drawAt(e){
  const rect = maskCan.getBoundingClientRect();
  const x = (e.clientX-rect.left)/rect.width * imgW;
  const y = (e.clientY-rect.top )/rect.height* imgH;
  mctx.globalCompositeOperation = (tool==='eraser')?'destination-out':'source-over';
  mctx.fillStyle='rgba(255,255,255,1)';
  const r = +sizeEl.value/2;
  mctx.beginPath(); mctx.arc(x,y,r,0,Math.PI*2); mctx.fill();
}

/* ================== КОЛІР / МАТЕРІАЛ / ПЕРФОРАЦІЯ ================== */
const paletteEl = document.getElementById('palette');
const anyColorEl= document.getElementById('anyColor');
const materialEl= document.getElementById('material');
const perforEl  = document.getElementById('perforated');
const btnApply  = document.getElementById('btnApply');

const PALETTE = [
  '#ffffff','#e6e6e6','#c0c0c0','#999999','#666666','#333333','#000000','#7f0000','#ff0000','#ff6a00',
  '#ffb300','#ffe100','#ccff00','#62ff00','#00ffad','#00e1ff','#0090ff','#003bff','#6a00ff','#ff00e1'
];

function makePalette(){
  paletteEl.innerHTML='';
  PALETTE.forEach(col=>{
    const b=document.createElement('button');
    b.className='sw'; b.style.background=col; b.title=col;
    b.onclick=()=>{ anyColorEl.value = toHex(col); };
    paletteEl.appendChild(b);
  });
}
function toHex(c){ // normalize 3/6/rgba to #RRGGBB
  const ctx = document.createElement('canvas').getContext('2d');
  ctx.fillStyle=c; return ctx.fillStyle;
}
makePalette();

document.getElementById('btnStitches').onclick=()=>{
  alert('Вікно строчок (демо): тут з’явиться конструктор ромбів/швів. Зараз — заглушка.');
};

btnApply.addEventListener('click', ()=>{
  if(!hasImage) return alert('Завантаж фото');
  if(!baseImgData) return;
  // Беремо оригінал та перефарбовуємо ТІЛЬКИ де маска 255.
  const out = new ImageData(new Uint8ClampedArray(baseImgData.data), imgW, imgH);
  const mask = mctx.getImageData(0,0,imgW,imgH).data;
  const hex = anyColorEl.value; // #rrggbb
  const target = hexToRgb(hex);

  for(let i=0;i<imgW*imgH;i++){
    const a = mask[i*4+3];
    if(a<10) continue; // поза маскою — пропускаємо
    const j=i*4;
    // збережемо світлоту зображення, а тон беремо з target (простий HSL-lite)
    const r=out.data[j], g=out.data[j+1], b=out.data[j+2];
    const lum = 0.2126*r + 0.7152*g + 0.0722*b; // яскравість
    const tLum = 0.2126*target.r + 0.7152*target.g + 0.0722*target.b || 1;
    const k = lum / tLum;
    out.data[j  ] = clamp(target.r * k);
    out.data[j+1] = clamp(target.g * k);
    out.data[j+2] = clamp(target.b * k);
    out.data[j+3] = 255;
  }

  // Матеріал (легкий ефект): алькантара — трохи більше “матовості”
  if(materialEl.value==='alcantara'){
    for(let i=0;i<imgW*imgH;i++){
      const j=i*4;
      out.data[j  ] = (out.data[j  ]*0.98)|0;
      out.data[j+1] = (out.data[j+1]*0.98)|0;
      out.data[j+2] = (out.data[j+2]*0.98)|0;
    }
  }

  // Перфорація: простий візерунок “дірочок” (демо)
  if(perforEl.checked){
    const step = Math.max(6, Math.floor(Math.min(imgW,imgH)/120));
    for(let y=0;y<imgH;y+=step){
      for(let x=0;x<imgW;x+=step){
        const i=(y*imgW+x)*4;
        // зменшуємо яскравість точки → вигляд отвору
        out.data[i  ] = (out.data[i  ]*0.75)|0;
        out.data[i+1] = (out.data[i+1]*0.75)|0;
        out.data[i+2] = (out.data[i+2]*0.75)|0;
      }
    }
  }

  pctx.putImageData(out,0,0);
  logEl.innerHTML = `<span class="ok">OK</span> Застосовано в межах маски.`;
});

function hexToRgb(h){
  const s = h.replace('#','');
  const v = s.length===3 ? s.split('').map(ch=>ch+ch).join('') : s;
  return {
    r: parseInt(v.substring(0,2),16),
    g: parseInt(v.substring(2,4),16),
    b: parseInt(v.substring(4,6),16)
  };
}
function clamp(v){ return v<0?0:v>255?255:v|0; }
</script>

</body>
</html>
